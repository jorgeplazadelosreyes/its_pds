<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/konva@8.3.12/konva.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous"/>
	<title>Editar DCL</title>
	<!-- <h2 style="margin_down:20; outline: black solid; text-align:center">Aca saldra un enunciado </h2> -->
	<style>
		body {
			margin_top: 20;
			margin_left: 20;
			overflow: scroll;
			background-color: #f0f0f0;
			outline: black solid
		}
	</style>
  <div class="container">
    <div class="row mb-3">
      <div class="text-center row align-item-center">
        <div class="col" style="background-color: #393E46">
          <h3 for="exampleFormControlTextarea1" class="form-label" style="margin-top:20px; color: #EEEEEE">Enunciado</h3>
        </div>
      </div>
      <h3 id="statement-text" style="margin-top:15px">{{ homework.statement_text }}</h3>
    </div>
    <div class="row mb-3">
      <h7> Instruccion: Debes diagramar el DCL segun las fuerzas existentes en el sistema. Puedes hacerle click a los elementos para asignar sus respectivas fuerzas.</h7>
    </div>
  </div>
</head>
<body>
  <h6 id="homework-details" 
    data-homework-id="{{ homework.id }}"
    data-homework-diagram = "{{ homework.diagram }}" 
    data-homework-statement="{{ homework.statement_text }}" 
    data-homework-difficulty="{{ homework.difficulty }}" 
    data-homework-final = "{{ homework.final_stage }}">
  </h6>
    
	<div id="container" style="margin-left: 20px"></div>
	<script>
  	var alto = window.innerHeight - 200;
		var largo = window.innerWidth - 30;
		var shadowOffset = 20;
		var tween = null;
		var blockSnapSize = 30;

		var shadowRectangle = new Konva.Rect({
			x: 0,
			y: 0,
			width: blockSnapSize,
			height: blockSnapSize,
			fill: '#FF7B17',
			opacity: 0.6,
			stroke: '#CF6412',
			strokeWidth: 3,
			dash: [20, 2]
		});
      
			data = $("#homework-details").data("homeworkDiagram")

			//var stage = Konva.Node.create(data, "container")

      //flechas 1 fuerza, flecha 2 fuerzas, fijos, deslizantes, empotrados, momentos
      element_tracking = [0,0,0,0,0,0]
      user_tracking = [0,0,0,0,0,0]
      strikes = 0
      var answer_arrows = []
      var answer_fijo = []
      var answer_deslizante = []
      var answer_empotrado = []
      var answer_momento = []
      function loadForm(json, counter){
        
        objects=json["children"][0]["children"]

        var fuerzas  = []
        var momentos = []
        var incognitas = []
        
        dic_bielas = {}
        
        for (var i = 0; i<objects["length"]; i++){
          

          if(objects[i]["className"]=="Rect"){
            if(objects[i]["attrs"]["name"]=='barra'){
                item=objects[i]
                
                newBarra(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["width"],item["attrs"]["rotation"], layer, stage)
                
              }
          }
          
          if(objects[i]["className"]=="Arc"){

            if( String( objects[i]["attrs"]["name"] ).substring(0,7) == 'momento' && String( objects[i]["attrs"]["name"] ).substring(8,12) != "tool"){
                item=objects[i]
                counter[6] = counter[6] + 1
                element_tracking[5] = element_tracking[5] + 1
                num = String(item["attrs"]["name"]).split("_")[1]
                
                
                for (var j = 0; j<objects["length"]; j++){
                  
                  if(String( objects[j]["attrs"]["name"] ).split("_")[0] == 'textMoment' && String( objects[j]["attrs"]["name"] ).split("_")[1] == num){
                    magn = String(objects[j]["attrs"]["text"])
                    
                    item["attrs"]["magnitud"] = magn
                  }
                }
                answer_momento.push(item["attrs"])
                newMomento(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage, num, item["attrs"]["magnitud"])
                
                var newM = [];

                newM.push(item["attrs"]["name"], item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], item["attrs"]["magnitud"])
                momentos.push(newM)
              }
          }
          if(objects[i]["className"]=="Arrow"){
            if(String( objects[i]["attrs"]["name"] ).substring(0,5) == 'arrow' && String( objects[i]["attrs"]["name"] ).substring(6,10) != "tool"){
                item=objects[i]
                counter[0] = counter[0] + 1
                num = String(item["attrs"]["name"]).split("_")[1]
                
                
                for (var j = 0; j<objects["length"]; j++){
                  
                  if(String( objects[j]["attrs"]["name"] ).split("_")[0] == 'textArrow' && String( objects[j]["attrs"]["name"] ).split("_")[1] == num){
                    magn = String(objects[j]["attrs"]["text"])
                    
                    item["attrs"]["magnitud"] = magn
                  }
                } 
                console.log(Math.round(item["attrs"]["rotation"]))
                if ([-180,-90,-0,0,90,180, NaN].includes(Math.round(item["attrs"]["rotation"]))){
                  element_tracking[0] = element_tracking[0] + 1
                } else if ([-135,-45,45,135].includes(Math.round(item["attrs"]["rotation"]))){
                  element_tracking[1] = element_tracking[1] + 2
                }
                answer_arrows.push(item["attrs"])
                newArrow(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage, num, item["attrs"]["magnitud"])
                
                var newForce = [];

                newForce.push(item["attrs"]["name"], item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], item["attrs"]["magnitud"])
                fuerzas.push(newForce)
            }
          }
          if(objects[i]["className"]=="RegularPolygon"){

            if(String( objects[i]["attrs"]["name"] ).substring(0,4) == 'fijo' && String( objects[i]["attrs"]["name"] ).substring(5,9) != "tool"){

              var fijoInc = []
              fijoInc.push(objects[i]["attrs"]["name"], objects[i]["attrs"]["x"], objects[i]["attrs"]["y"], objects[i]["attrs"]["rotation"], objects[i]["attrs"]["magnitud_x"], objects[i]["attrs"]["magnitud_y"])
              incognitas.push(fijoInc)  
                
              item=objects[i]
              counter[1] = counter[1] + 1
              element_tracking[2] = element_tracking[2] + 2
              answer_fijo.push(item["attrs"])
              console.log(item["attrs"]["rotation"])
              newFijo(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage, String(objects[i]["attrs"]["name"]).split("_")[1])
            }
          }
          if(objects[i]["className"]=="Group"){
            if(String( objects[i]["attrs"]["name"] ).substring(0,10) == 'deslizante' && String( objects[i]["attrs"]["name"] ).substring(11,15) != "tool"){

              var desInc =[]
              desInc.push(objects[i]["attrs"]["name"], objects[i]["attrs"]["x"], objects[i]["attrs"]["y"], objects[i]["attrs"]["rotation"], objects[i]["attrs"]["magnitud"])
              incognitas.push(desInc)
              
              item=objects[i]
              counter[2] = counter[2] + 1
              element_tracking[3] = element_tracking[3] + 1
              answer_deslizante.push(item["attrs"])
              newDeslizante(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage, String(objects[i]["attrs"]["name"]).split("_")[1])
            }
            else if(String( objects[i]["attrs"]["name"] ).substring(0,9) == 'empotrado' && String( objects[i]["attrs"]["name"] ).substring(10,14) != "tool"){
              
              var empInc = []
              empInc.push(objects[i]["attrs"]["name"], objects[i]["attrs"]["x"], objects[i]["attrs"]["y"], objects[i]["attrs"]["rotation"], objects[i]["attrs"]["magnitud_x"], objects[i]["attrs"]["magnitud_y"], objects[i]["attrs"]["magnitud_m"])
              incognitas.push(empInc)
              
              item=objects[i]
              counter[3] = counter[3] + 1
              element_tracking[4] = element_tracking[4] + 3
              answer_empotrado.push(item["attrs"])
              newEmpotrado(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage, String(objects[i]["attrs"]["name"]).split("_")[1]) 
            }
          }
          if(objects[i]["className"]=="Circle" || objects[i]["className"]=="Line"){
            if(String( objects[i]["attrs"]["name"] ).substring(0,6) == 'rotula' && String( objects[i]["attrs"]["name"] ).substring(7,11) != "tool"){
              item=objects[i]
              counter[4] = counter[4] + 1
              newRotula(item["attrs"]["x"], item["attrs"]["y"], layer, stage, String(objects[i]["attrs"]["name"]).split("_")[1])
            }
            else if(String( objects[i]["attrs"]["name"] ).substring(0,5) == 'punto' && String( objects[i]["attrs"]["name"] ).substring(6,10) != "tool"){
              item=objects[i]
              counter[7] = counter[7] + 1
              newPunto(item["attrs"]["x"], item["attrs"]["y"], layer, stage)
              var punto = [item["attrs"]["x"], item["attrs"]["y"]]
            }
            else if(String( objects[i]["attrs"]["name"] ).substring(0,6) == 'biela1' && String( objects[i]["attrs"]["name"] ).substring(7,11) != "tool"){
              item=objects[i]
              x1 = item["attrs"]["x"]
              y1 = item["attrs"]["y"]

              if(dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]]){

                dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]].push(x1)
                dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]].push(y1)

                x2 = dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]][0]
                y2 = dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]][1]

                counter[5] = counter[5] + 1

                newBiela( x1, y1, x2, y2, layer, stage, String(objects[i]["attrs"]["name"]).split("_")[1])
              }
              else{
                dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]] = [x1, y1]
              }
            }
            
            else if(String( objects[i]["attrs"]["name"] ).substring(0,6) == 'biela2' && String( objects[i]["attrs"]["name"] ).substring(7,11) != "tool"){
              item=objects[i]
              x2 = item["attrs"]["x"]
              y2 = item["attrs"]["y"]
              if(dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]]){
                dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]].push(x2)
                dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]].push(y2)

                x1 = dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]][0]
                y1 = dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]][1]

                counter[5] = counter[5] + 1

                newBiela( x1, y1, x2, y2, layer, stage, String(objects[i]["attrs"]["name"]).split("_")[1])
              }
              else{
                dic_bielas[String(objects[i]["attrs"]["name"]).split("_")[1]] = [x2, y2]
              }
            }
          }
        }
          
          return {fuerzas, momentos, incognitas, punto};
        }   

      console.log(data["children"][0]["children"]);

      const stage = new Konva.Stage({
          container: 'container',
          width: largo,
          height: alto
        });
		
      
			var layer = new Konva.Layer();
				
			var padding = 30;
			for (var i = 0; i < (largo / padding) - 2; i++) {
				layer.add(new Konva.Line({
					points: [Math.round(i * padding) + 0.5, 0, Math.round(i * padding) + 0.5, alto],
					stroke: '#000000',
					strokeWidth: 1,
				}));
			}
			layer.add(new Konva.Line({points: [0,0,10,10]}));
      
			for (var j = 0; j < (largo / padding); j++) {
				layer.add(new Konva.Line({
					points: [0, Math.round(j * padding), largo - 85, Math.round(j * padding)],
					stroke: '#000000',
					strokeWidth: 0.5,
				}));
			}
      function calcularFXYM(incognitas, Fx, Fy, momentos, punto){
       
        var sumaX = 0
        var sumaY = 0
        var incX = []
        var incY = []
        var strX = ""
        var strY = ""
        var strM = ""

        // PARA LAS FUERZAS EN EJE X E Y
        for(var i = 0; i<Fx.length; i++){
          sumaX += Fx[i][1]
        }
        for(var i = 0; i<Fy.length; i++){
          sumaY += Fy[i][1]
        }


        for(var i = 0; i<incognitas.length; i++){
          if(String(incognitas[i][0]).split("_")[0] == "fijo"){
            incX.push(incognitas[i][4])
            incY.push(incognitas[i][5])
          }

          if(String(incognitas[i][0]).split("_")[0] == "deslizante"){

            if(incognitas[i][3] == 90 || incognitas[i][3] == -90 ){
              incX.push(incognitas[i][4])
            }
            else{
              incY.push(incognitas[i][4])
            }
          }

          if(String(incognitas[i][0]).split("_")[0] == "empotrado"){
            incX.push(incognitas[i][4])
            incY.push(incognitas[i][5])
          }
        }

        // PARA EL MOMENTO
        var sumaM = []

        for(var i = 0; i<Fx.length; i++){
          sumaM.push( Fx[i][1] * Math.round(punto[1] - Fx[i][3]) * -1)
        }
        for(var i = 0; i<Fy.length; i++){
          sumaM.push( Fy[i][1] * Math.round(punto[0] - Fy[i][2]) * -1)
        }
        for(var i = 0; i<momentos.length; i++){
          sumaM.push( momentos[i][4])
        }

        for(var i = 0; i<incognitas.length; i++){
          if(String(incognitas[i][0]).split("_")[0] == "fijo"){
            sumaM.push(incognitas[i][4] + "*" + String(Math.round(punto[1] - incognitas[i][2]) * -1))
            sumaM.push(incognitas[i][5] + "*" + String(Math.round(punto[0] - incognitas[i][1]) * -1))
          }

          if(String(incognitas[i][0]).split("_")[0] == "deslizante"){

            if(incognitas[i][3] == 90 || incognitas[i][3] == -90 ){
              sumaM.push(incognitas[i][4] + "*" + String(Math.round(punto[1] - incognitas[i][2]) * -1))
            }
            else{
              sumaM.push(incognitas[i][4] + "*" + String(Math.round(punto[0] - incognitas[i][1]) * -1))
            }
          }

          if(String(incognitas[i][0]).split("_")[0] == "empotrado"){
            sumaM.push(incognitas[i][4] + "*" + String(Math.round((punto[1] - incognitas[i][2])) * -1))
            sumaM.push(incognitas[i][5] + "*" + String(Math.round((punto[0] - incognitas[i][1])) * -1))
            sumaM.push(incognitas[i][6])
          }
        }



        strX += String(sumaX) 
        for(var i = 0; i<incX.length; i++){
          strX += "+" + incX[i]
        }

        strY += String(sumaY) 
        for(var i = 0; i<incY.length; i++){
          strY += "+" + incY[i]
        }

        
        for(var i = 0; i<sumaM.length; i++){
          strM += "+" + String(sumaM[i])
        }

        strX += "=0"
        strY += "=0"
        strM += "=0"



        return {strX, strY, strM}

      }


      function cambiarPosInc(incognitas){

        for( i=0; i<incognitas.length; i++){

          if(incognitas[i][3] == undefined){
            incognitas[i][3] = 0
          }

          if(String(incognitas[i][0]).split("_")[0] == "fijo"){

            if( Math.round(incognitas[i][3]) == 0){
              incognitas[i][1] = incognitas[i][1] + 0
              incognitas[i][2] = incognitas[i][2] - 15
            }

            else if( Math.round(incognitas[i][3]) == -90){
              incognitas[i][1] = incognitas[i][1] - 15
              incognitas[i][2] = incognitas[i][2] - 0
            }

            else if( Math.round(incognitas[i][3]) == 180 || Math.round(incognitas[i][3]) == -180){
              incognitas[i][1] = incognitas[i][1] - 0
              incognitas[i][2] = incognitas[i][2] + 15
            }


            else if( Math.round(incognitas[i][3]) == 90){
              incognitas[i][1] = incognitas[i][1] + 15
              incognitas[i][2] = incognitas[i][2] - 0
            }

          }

          else if(String(incognitas[i][0]).split("_")[0] == "deslizante"){
            if( Math.round(incognitas[i][3]) == 0){
              incognitas[i][1] = incognitas[i][1] + 15
              incognitas[i][2] = incognitas[i][2] - 30
            }

            else if( Math.round(incognitas[i][3]) == -90){
              incognitas[i][1] = incognitas[i][1] - 30
              incognitas[i][2] = incognitas[i][2] - 15
            }

            else if( Math.round(incognitas[i][3]) == 180 || Math.round(incognitas[i][3]) == -180){
              incognitas[i][1] = incognitas[i][1] - 15
              incognitas[i][2] = incognitas[i][2] + 30
            }


            else if( Math.round(incognitas[i][3]) == 90){
              incognitas[i][1] = incognitas[i][1] + 30
              incognitas[i][2] = incognitas[i][2] + 15
            }
          }

          else if(String(incognitas[i][0]).split("_")[0] == "empotrado"){
            if( Math.round(incognitas[i][3]) == 0){
              incognitas[i][1] = incognitas[i][1] + 15
              incognitas[i][2] = incognitas[i][2] - 30
            }

            else if( Math.round(incognitas[i][3]) == -90){
              incognitas[i][1] = incognitas[i][1] - 30
              incognitas[i][2] = incognitas[i][2] - 15
            }

            else if( Math.round(incognitas[i][3]) == 180 || Math.round(incognitas[i][3]) == -180){
              incognitas[i][1] = incognitas[i][1] - 15
              incognitas[i][2] = incognitas[i][2] + 30
            }


            else if( Math.round(incognitas[i][3]) == 90){
              incognitas[i][1] = incognitas[i][1] + 30
              incognitas[i][2] = incognitas[i][2] + 15
            }
          }
          
        }

        return incognitas;
      }

      function cambiarPosMom(momentos){
        
        for( i=0; i<momentos.length; i++){
          
          momentos[i][2] = momentos[i][2] + 7.5;
           
        }

        return momentos;
      }

      function cambiarPos(fuerzas){
        

        for( i=0; i<fuerzas.length; i++){
          if(fuerzas[i][3] == undefined){
            fuerzas[i][3] = 0
          }
          
          if( Math.round(fuerzas[i][3]) == 0){
            
            fuerzas[i][1] = fuerzas[i][1] + 75
            
          }

          else if( Math.round(fuerzas[i][3]) == 45){
            fuerzas[i][1] = fuerzas[i][1] + 60
            fuerzas[i][2] = fuerzas[i][2] + 60
          }

          else if( Math.round(fuerzas[i][3]) == 90){
            fuerzas[i][1] = fuerzas[i][1] - 0
            fuerzas[i][2] = fuerzas[i][2] + 75
          }

          else if( Math.round(fuerzas[i][3]) == 135){
            fuerzas[i][1] = fuerzas[i][1] - 60
            fuerzas[i][2] = fuerzas[i][2] + 60
          }

          else if( Math.round(fuerzas[i][3]) == 180 ||  Math.round(fuerzas[i][3]) == -180 ){
            fuerzas[i][1] = fuerzas[i][1] - 75
            fuerzas[i][2] = fuerzas[i][2] - 0
          }

          else if( Math.round(fuerzas[i][3]) == -135){
            fuerzas[i][1] = fuerzas[i][1] - 55
            fuerzas[i][2] = fuerzas[i][2] - 55
          }

          else if( Math.round(fuerzas[i][3]) == -90){
            fuerzas[i][1] = fuerzas[i][1] - 0
            fuerzas[i][2] = fuerzas[i][2] - 75
          }

          else if( Math.round(fuerzas[i][3]) == -45){
            fuerzas[i][1] = fuerzas[i][1] + 60
            fuerzas[i][2] = fuerzas[i][2] - 60
          }

        }
        return fuerzas
      }

      function descomponerFuerzas(fuerzas){

        var Fx = []
        var Fy = []

        for( i=0; i<fuerzas.length; i++){
          if(fuerzas[i][3] == undefined){
            fuerzas[i][3] = 0
          }
          
          if( Math.round(fuerzas[i][3]) == 0){
            var f = []
            f.push(fuerzas[i][0], parseInt(fuerzas[i][4]), Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            Fx.push(f)
          }

          else if( Math.round(fuerzas[i][3]) == 45){
            var fx = []
            var fy = []

            f = -0.707 * parseInt(fuerzas[i][4])
            fy.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            
            Fy.push(fy)

            f = 0.707 * parseInt(fuerzas[i][4])
            fx.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            Fx.push(fx)
          }

          else if( Math.round(fuerzas[i][3]) == 90){
            var fy = []

            f = -1 * parseInt(fuerzas[i][4])
            fy.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            
            Fy.push(fy)
          }

          else if( Math.round(fuerzas[i][3]) == 135){
            var fx = []
            var fy = []

            f = -0.707 * parseInt(fuerzas[i][4])
            fy.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            
            Fy.push(fy)

            f = -0.707 * parseInt(fuerzas[i][4])
            fx.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            Fx.push(fx)
          }

          else if( Math.round(fuerzas[i][3]) == 180 ||  Math.round(fuerzas[i][3]) == -180 ){
            var fx = []

            f = -1 * parseInt(fuerzas[i][4])
            fx.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            
            Fx.push(fx)
          }

          else if( Math.round(fuerzas[i][3]) == -135){
            
            var fx = []
            var fy = []

            f1 = 0.707 * parseInt(fuerzas[i][4])
            fy.push(fuerzas[i][0], f1, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            
            Fy.push(fy)

            f = -0.707 * parseInt(fuerzas[i][4])
            fx.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            Fx.push(fx)

            
          }

          else if( Math.round(fuerzas[i][3]) == -90){
            var fy = []

            f = 1 * parseInt(fuerzas[i][4])
            fy.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            
            Fy.push(fy)
          }

          else if( Math.round(fuerzas[i][3]) == -45){
            var fx = []
            var fy = []

            f = 0.707 * parseInt(fuerzas[i][4])
            fy.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            
            Fy.push(fy)

            f = 0.707 * parseInt(fuerzas[i][4])
            fx.push(fuerzas[i][0], f, Math.round(fuerzas[i][1]), Math.round(fuerzas[i][2]))
            Fx.push(fx)
          }

        }
        return {Fx, Fy}
      }


      function getPointsBArra(x, y, r, width){

        x = Math.round(x);
        y = Math.round(y);
        r = Math.round(r);

        var x1;
        var y1;
        var x2;
        var y2;
        var x3;
        var y3;
        var x4;
        var y4;

        if(r == 0){
          x1 = x;
          y1 = y;
          x2 = x + width;
          y2 = y;
          x3 = x + width;
          y3 = y + 30;
          x4 = x;
          y4 = y + 30;
        }

        else if(r == 90){
          x1 = x;
          y1 = y;
          x2 = x;
          y2 = y + width;
          x3 = x - 30;
          y3 = y + width;
          x4 = x - 30;
          y4 = y;
        }

        else if(r == 180 || r == -180){
          x1 = x;
          y1 = y;
          x2 = x - width;
          y2 = y;
          x3 = x - width;
          y3 = y - 30;
          x4 = x;
          y4 = y - 30;
        }

        else if(r == -90){
          x1 = x;
          y1 = y;
          x2 = x;
          y2 = y - width;
          x3 = x + 30;
          y3 = y - width;
          x4 = x + 30;
          y4 = y;
        }

        console.log(x1, y1)
        console.log(x2, y2)
        console.log(x3, y3)
        console.log(x4, y4)

        return {x1, y1, x2, y2, x3, y3, x4, y4}
      }


			function newArrow(x, y, rotation = 0, layer, stage, count, magnitud = 0) {
				var arrow = new Konva.Arrow({
					x: x,
					y: y,
					points: [0, 0, 75, 0],
					pointerLength: 2,
					pointerWidth: 2,
					fill: 'black',
					stroke: 'black',
					strokeWidth: 4,
					shadowColor: 'black',
					shadowBlur: 2,
					shadowOffset: {x : 1, y : 1},
					shadowOpacity: 0.4,
					draggable: false,
					rotation: 0,
          name: "arrow_" + count.toString(),
          rotation: rotation,
          magnitud: magnitud,
				});
        
        layer.add(arrow);
        stage.on('click tap', function (e) {
          if (e.target === arrow) {
            textNode.hide()
            textInfo.hide()
            //console.log(Math.round(e.target.attrs.rotation))
            arrow_split = setDclArrows()
            //QUIZAS ACA HACER CONDICIONES PARA PILLAR HINT
            if (arrow_split == 2 && Math.round(e.target.attrs.rotation) == 45){
              newDclArrow(e.target.attrs.x - 20, e.target.attrs.y + 60, 0, layer, stage, count, String(e.target.attrs.magnitud)+"cos("+String(Math.round(e.target.attrs.rotation))+")")
              newDclArrow(e.target.attrs.x + 60, e.target.attrs.y - 20, 90, layer, stage, count, String(e.target.attrs.magnitud * -1)+"sen("+String(Math.round(e.target.attrs.rotation))+")")
              user_tracking[1] = user_tracking[1] + 2
            } else if (arrow_split == 2 && Math.round(e.target.attrs.rotation) == 135){
              newDclArrow(e.target.attrs.x + 20 , e.target.attrs.y + 60, 180, layer, stage, count, String(e.target.attrs.magnitud)+"cos("+String(Math.round(e.target.attrs.rotation))+")")
              newDclArrow(e.target.attrs.x - 60, e.target.attrs.y - 20, 90, layer, stage, count, String(e.target.attrs.magnitud * -1)+"sen("+String(Math.round(e.target.attrs.rotation))+")")
              user_tracking[1] = user_tracking[1] + 2
            } else if (arrow_split == 2 && Math.round(e.target.attrs.rotation) == -45){
              newDclArrow(e.target.attrs.x - 20 , e.target.attrs.y - 60, 0, layer, stage, count, String(e.target.attrs.magnitud)+"cos("+String(Math.round(e.target.attrs.rotation))+")")
              newDclArrow(e.target.attrs.x + 60, e.target.attrs.y + 20, -90, layer, stage, count,String(e.target.attrs.magnitud * -1)+"sen("+String(Math.round(e.target.attrs.rotation))+")")
              user_tracking[1] = user_tracking[1] + 2
            } else if (arrow_split == 2 && Math.round(e.target.attrs.rotation) == -135){
              newDclArrow(e.target.attrs.x + 20 , e.target.attrs.y - 60, 180, layer, stage, count,String(e.target.attrs.magnitud)+"cos("+String(Math.round(e.target.attrs.rotation))+")")
              newDclArrow(e.target.attrs.x - 60, e.target.attrs.y + 20, -90, layer, stage, count, String(e.target.attrs.magnitud * -1)+"sen("+String(Math.round(e.target.attrs.rotation))+")")
              user_tracking[1] = user_tracking[1] + 2
            } else if (arrow_split == 1 && Math.round(e.target.attrs.rotation) == 0){
              newDclArrow(e.target.attrs.x, e.target.attrs.y, 0, layer, stage, count, e.target.attrs.magnitud)
              user_tracking[0] = user_tracking[0] + 1
            } else if (arrow_split == 1 && Math.round(e.target.attrs.rotation) == -180){
              newDclArrow(e.target.attrs.x, e.target.attrs.y, 180, layer, stage, count, e.target.attrs.magnitud * -1)
              user_tracking[0] = user_tracking[0] + 1
            } else if (arrow_split == 1 && Math.round(e.target.attrs.rotation) == 90){
              newDclArrow(e.target.attrs.x, e.target.attrs.y, 90, layer, stage, count, e.target.attrs.magnitud * -1)
              user_tracking[0] = user_tracking[0] + 1
            } else if (arrow_split == 1 && Math.round(e.target.attrs.rotation) == -90){
              newDclArrow(e.target.attrs.x, e.target.attrs.y, -90, layer, stage, count, e.target.attrs.magnitud)
              user_tracking[0] = user_tracking[0] + 1
            } else {
              alert("¡Intenta de nuevo! Este elemento... ¿cuantas fuerzas involucra?")
              strikes += 1
              textNode.show()
              textInfo.show()
            }
          }
        });

        /// fuerza en arrow

        var textNode = new Konva.Text({
          text: magnitud,
          x: arrow.x() + 10,
          y: arrow.y() + 10,
          fontSize: 13,
          name: "textArrow_" + count.toString(),
        });

        var textInfo= new Konva.Text({
          text: "X:" + String(Math.round(arrow.x())) + " Y:" + String(Math.round(arrow.y())) + " R:" + String(Math.round(arrow.rotation())),
          x: arrow.x() + 20,
          y: arrow.y() + 23,
          fontSize: 13,
          fill: 'black',
        });
        
        layer.add(textInfo);
        layer.add(textNode);
      }
      function newDclArrow(x, y, rotation = 0, layer, stage, count, magnitud = 0) {
				var arrow = new Konva.Arrow({
					x: x,
					y: y,
					points: [0, 0, 75, 0],
					pointerLength: 2,
					pointerWidth: 2,
					fill: 'black',
					stroke: 'red',
					strokeWidth: 4,
					draggable: false,
          name: "arrow_" + count.toString(),
          rotation: rotation,
          magnitud: magnitud,
				});
        
        layer.add(arrow);
        /// fuerza en arrow
        var textNode = new Konva.Text({
          text: magnitud,
          x: arrow.x() + 10,
          y: arrow.y() + 10,
          fontSize: 13,
          name: "textArrow_" + count.toString(),
        });
        layer.add(textNode);
      }

      function newFijo(x, y, rotation = 0, layer, stage, count) {
        let fijo = new Konva.RegularPolygon({
          x: x,
          y: y,
          sides: 3,
          radius: 15,
          fill: 'grey',
          stroke: 'black',
          strokeWidth: 2,
          shadowColor: 'black',
          shadowBlur: 2,
          shadowOffset: {x : 1, y : 1},
          shadowOpacity: 0.4,
          draggable: false,
          name: "fijo_" + count.toString(),
          rotation: rotation,
          magnitud_x: "Fx_" + count.toString(),
          magnitud_y: "Fy_" + count.toString(),
        });

        layer.add(fijo);
        stage.on('click tap', function (e) {
          if (e.target === fijo) {
            textInfo.hide()
            arrow_split = setDclArrows()
            if (arrow_split == 2 && Math.round(e.target.attrs.rotation) == 0){
              newDclArrow(e.target.attrs.x - 85, e.target.attrs.y, 0, layer, stage, count, e.target.attrs.magnitud_x)
              newDclArrow(e.target.attrs.x, e.target.attrs.y + 85, -90, layer, stage, count, e.target.attrs.magnitud_y)
              user_tracking[2] = user_tracking[2] + 2
            } else if (arrow_split == 2 && Math.round(e.target.attrs.rotation) == 90){
              newDclArrow(e.target.attrs.x - 85, e.target.attrs.y, 0, layer, stage, count, e.target.attrs.magnitud_x)
              newDclArrow(e.target.attrs.x, e.target.attrs.y - 85, 90, layer, stage, count, e.target.attrs.magnitud_y)
              user_tracking[2] = user_tracking[2] + 2
            } else if (arrow_split == 2 && Math.round(e.target.attrs.rotation) == 180){
              newDclArrow(e.target.attrs.x + 85, e.target.attrs.y, 180, layer, stage, count, e.target.attrs.magnitud_x)
              newDclArrow(e.target.attrs.x, e.target.attrs.y - 85, 90, layer, stage, count, e.target.attrs.magnitud_y)
              user_tracking[2] = user_tracking[2] + 2
            } else if (arrow_split == 2 && Math.round(e.target.attrs.rotation) == -90){
              newDclArrow(e.target.attrs.x + 85, e.target.attrs.y, 180, layer, stage, count, e.target.attrs.magnitud_x)
              newDclArrow(e.target.attrs.x, e.target.attrs.y + 85, -90, layer, stage, count, e.target.attrs.magnitud_y)
              user_tracking[2] = user_tracking[2] + 2
            } else {
              alert("¡Intenta de nuevo! Este elemento... ¿cuantas fuerzas involucra?")
              strikes += 1
              textInfo.show()
            }
          }
        });
        var textInfo= new Konva.Text({
          text: "X:" + String(Math.round(fijo.x())) + " Y:" + String(Math.round(fijo.y())) + " R:" + String(Math.round(fijo.rotation())),
          x: fijo.x() + 20,
          y: fijo.y() + 23,
          fontSize: 13,
          fill: 'black',
        });

        layer.add(textInfo)
      }

      function newDeslizante(x, y, rotation = 0, layer, stage, count) {
        var deslizante = new Konva.Group({
          x: x,
          y: y,
          shadowColor: 'black',
          shadowBlur: 2,
          shadowOffset: {x : 1, y : 1},
          shadowOpacity: 0.4,
          draggable: false,
          name: "deslizante_" + count.toString(),
          rotation: rotation,
          magnitud: "D_" + count.toString(),
        });

        var deslizanteT = new Konva.RegularPolygon({
          x: 15,
          y: -13,
          sides: 3,
          radius: 15,
          fill: 'gray',
          stroke: 'black',
          strokeWidth: 2,
        });

        var deslizanteL = new Konva.Line({
          points: [0, 0, 30, 0],
          stroke: 'red',
          strokeWidth: 4,
          lineCap: 'round',
          lineJoin: 'round',
         
        });
        deslizante.add(deslizanteT);
        deslizante.add(deslizanteL);

        layer.add(deslizante);
        stage.on('click tap', function (e) {
          if (e.target === deslizanteT) {
            textInfo.hide()
            arrow_split = setDclArrows()
            console.log(e.target)
            if (arrow_split == 1 && Math.round(e.target.parent.attrs.rotation) == 0){
              newDclArrow(e.target.parent.attrs.x + 15, e.target.parent.attrs.y + 65, -90, layer, stage, count, e.target.parent.attrs.magnitud)
              user_tracking[3] = user_tracking[3] + 1
            } else if (arrow_split == 1 && Math.round(e.target.parent.attrs.rotation) == 90){
              newDclArrow(e.target.parent.attrs.x - 65, e.target.parent.attrs.y + 15, 0, layer, stage, count, e.target.parent.attrs.magnitud)
              user_tracking[3] = user_tracking[3] + 1
            } else if (arrow_split == 1 && Math.round(e.target.parent.attrs.rotation) == 180){
              newDclArrow(e.target.parent.attrs.x - 15, e.target.parent.attrs.y - 65, 90, layer, stage, count, e.target.parent.attrs.magnitud)
              user_tracking[3] = user_tracking[3] + 1
            } else if (arrow_split == 1 && Math.round(e.target.parent.attrs.rotation) == -90){
              newDclArrow(e.target.parent.attrs.x + 65, e.target.parent.attrs.y - 15, 180, layer, stage, count, e.target.parent.attrs.magnitud)
              user_tracking[3] = user_tracking[3] + 1
            } else {
              alert("¡Intenta de nuevo! Este elemento... ¿cuantas fuerzas involucra?")
              strikes += 1
              textInfo.show()
            }
          }
        })

        var textInfo= new Konva.Text({
          text: "X:" + String(Math.round(deslizante.x())) + " Y:" + String(Math.round(deslizante.y())) + " R:" + String(Math.round(deslizante.rotation())),
          x: deslizante.x() + 20,
          y: deslizante.y() + 23,
          fontSize: 13,
          fill: 'black',
        });
        layer.add(textInfo);
      }

      function newEmpotrado(x, y, rotation = 0, layer, stage, count) {
        var empotrado= new Konva.Group({
          x: x,
          y: y,
          shadowColor: 'black',
          shadowBlur: 2,
          shadowOffset: {x : 1, y : 1},
          shadowOpacity: 0.4,
          draggable: false,
          name: "empotrado_" + count.toString(),
          rotation: rotation,
          magnitud_x: "Ex_" + count.toString(),
          magnitud_y: "Ey_" + count.toString(),
          magnitud_m: "Em_" + count.toString(),
        });

        var empotrado1 = new Konva.Line({
          points: [15, 0, 15, -25],
          stroke: 'red',
          strokeWidth: 4,
          lineCap: 'round',
          lineJoin: 'round',
        });

        var empotrado2 = new Konva.Line({
          points: [0, 0, 30, 0],
          stroke: 'red',
          strokeWidth: 4,
          lineCap: 'round',
          lineJoin: 'round',
        });
        empotrado.add(empotrado1);
        empotrado.add(empotrado2);
        
        layer.add(empotrado);
        stage.on('click tap', function (e) {
          if (e.target === empotrado1 || e.target === empotrado2) {
            textInfo.hide()
            arrow_split = setDclArrows()
            console.log(e.target.parent.attrs.rotation)
            if (arrow_split == 3 && Math.round(e.target.parent.attrs.rotation) == 0){
              newDclArrow(e.target.parent.attrs.x -65, e.target.parent.attrs.y - 15, 0, layer, stage, count, e.target.parent.attrs.magnitud_x)
              newDclArrow(e.target.parent.attrs.x + 15, e.target.parent.attrs.y + 65, -90, layer, stage, count, e.target.parent.attrs.magnitud_y)
              newDclMomento(e.target.parent.attrs.x + 30, e.target.parent.attrs.y - 30, 0, layer, stage, count, e.target.parent.attrs.magnitud_m)
              user_tracking[4] = user_tracking[4] + 3
            } else if (arrow_split == 3 && Math.round(e.target.parent.attrs.rotation) == 90){
              newDclArrow(e.target.parent.attrs.x - 65, e.target.parent.attrs.y + 15, 0, layer, stage, count, e.target.parent.attrs.magnitud_x)
              newDclArrow(e.target.parent.attrs.x + 15, e.target.parent.attrs.y - 65, 90, layer, stage, count, e.target.parent.attrs.magnitud_y)
              newDclMomento(e.target.parent.attrs.x + 30, e.target.parent.attrs.y + 30, 0, layer, stage, count, e.target.parent.attrs.magnitud_m)
              user_tracking[4] = user_tracking[4] + 3
            } else if (arrow_split == 3 && Math.round(e.target.parent.attrs.rotation) == 180){
              newDclArrow(e.target.parent.attrs.x + 65, e.target.parent.attrs.y + 15, 180, layer, stage, count, e.target.parent.attrs.magnitud_x)
              newDclArrow(e.target.parent.attrs.x -15, e.target.parent.attrs.y - 65, 90, layer, stage, count, e.target.parent.attrs.magnitud_y)
              newDclMomento(e.target.parent.attrs.x - 30, e.target.parent.attrs.y + 30, 0, layer, stage, count, e.target.parent.attrs.magnitud_m)
              user_tracking[4] = user_tracking[4] + 3
            } else if (arrow_split == 3 && Math.round(e.target.parent.attrs.rotation) == -90){
              newDclArrow(e.target.parent.attrs.x + 65, e.target.parent.attrs.y - 15, 180, layer, stage, count, e.target.parent.attrs.magnitud_x)
              newDclArrow(e.target.parent.attrs.x - 15, e.target.parent.attrs.y + 65, -90, layer, stage, count, e.target.parent.attrs.magnitud_y)
              newDclMomento(e.target.parent.attrs.x - 30, e.target.parent.attrs.y -30, 0, layer, stage, count, e.target.parent.attrs.magnitud_m)
              user_tracking[4] = user_tracking[4] + 3
            } else {
              alert("¡Intenta de nuevo! Este elemento... ¿cuantas fuerzas involucra?")
              strikes += 1
              textInfo.show()
            }
          }
        });
        var textInfo= new Konva.Text({
          text: "X:" + String(Math.round(empotrado.x())) + " Y:" + String(Math.round(empotrado.y())) + " R:" + String(Math.round(empotrado.rotation())),
          x: empotrado.x() + 20,
          y: empotrado.y() + 23,
          fontSize: 13,
          fill: 'black',
        });

        empotrado.on('dragend', (e) => {
          textInfo.position({
            x: Math.round(empotrado.x() / blockSnapSize) * blockSnapSize - 45,
            y: Math.round(empotrado.y() / blockSnapSize) * blockSnapSize + 33
          });
          stage.batchDraw();
          textInfo.text("X:" + String(Math.round(empotrado.x())) + " Y:" + String(Math.round(empotrado.y())) + " R:" + String(Math.round(empotrado.rotation())))
        });
        
        layer.add(textInfo);
      }

      function newRotula(x, y, layer, stage, count) {

        var rotula = new Konva.Circle({
          x: x,
          y: y,
          radius: 15,
          fill: 'red',
          stroke: 'black',
          strokeWidth: 2,
          shadowColor: 'black',
          shadowBlur: 2,
          shadowOffset: {x : 1, y : 1},
          shadowOpacity: 0.4,
          draggable: false,
          name: "rotula_" + count.toString(),
        });

        rotula.on('dragstart', (e) => {
          shadowRectangle.show();
          shadowRectangle.moveToTop();
          rotula.moveToTop();
          console.log(rotula.name())
        });
        rotula.on('dragend', (e) => {
          rotula.position({
            x: Math.round(rotula.x() / blockSnapSize) * blockSnapSize + 15,
            y: Math.round(rotula.y() / blockSnapSize) * blockSnapSize + 15
          });
          stage.batchDraw();
          shadowRectangle.hide();
        });
        rotula.on('dragmove', (e) => {
          shadowRectangle.position({
            x: Math.round(rotula.x() / blockSnapSize) * blockSnapSize,
            y: Math.round(rotula.y() / blockSnapSize) * blockSnapSize
          });
          stage.batchDraw();
        });
        layer.add(rotula);

        var textInfo= new Konva.Text({
          text: "X:" + String(Math.round(rotula.x())) + " Y:" + String(Math.round(rotula.y())),
          x: rotula.x() + 20,
          y: rotula.y() + 23,
          fontSize: 13,
          fill: 'black',
          

        });

        rotula.on('dragend', (e) => {
          textInfo.position({
            x: Math.round(rotula.x() / blockSnapSize) * blockSnapSize - 45,
            y: Math.round(rotula.y() / blockSnapSize) * blockSnapSize + 33

          });
          stage.batchDraw();

          textInfo.text("X:" + String(Math.round(rotula.x())) + " Y:" + String(Math.round(rotula.y())) )
          
        });
        
        layer.add(textInfo);

        var tr = new Konva.Transformer({
          nodes: [rotula],
          centeredScaling: false,
          resizeEnabled: false,
          rotationSnaps: [0],
          rotationSnapTolerance: 360,
        });
        layer.add(tr);

        stage.on('click tap', function (e) {
          if (e.target === rotula) {
            tr.nodes([rotula]);
          }
          // if click on empty area - remove all selections
          if (e.target === stage) {
            tr.nodes([]);
            return;
          }

          const metaPressed = e.evt.ctrlKey;
          const isSelected = tr.nodes().indexOf(e.target) >= 0;

          if (metaPressed && isSelected) {
            if (e.target === rotula){
              dificultad -= 2
              }
            // if we pressed keys and node was selected
            // we need to remove it from selection:
            tr.nodes([]);
            const nodes = e.target.destroy(); // use slice to have new copy of array
            // remove node from array
          }
        });
        
      }
      function newBiela(x1, y1, x2=x1+30, y2=y1, layer, stage, count) {

        var b1 = new Konva.Circle({
          x: x1,
          y: y1,
          radius: 15,
          fill: 'green',
          stroke: 'black',
          strokeWidth: 2,
          shadowColor: 'black',
          shadowBlur: 2,
          shadowOffset: {x1 : 1, y1 : 1},
          shadowOpacity: 0.4,
          draggable: false,
          name: "biela1_" + count.toString(),
        });

        var b2 = new Konva.Circle({
          x: x2,
          y: y2,
          radius: 15,
          fill: 'green',
          stroke: 'black',
          strokeWidth: 2,
          shadowColor: 'black',
          shadowBlur: 2,
          shadowOffset: {x2 : 1, y2 : 1},
          shadowOpacity: 0.4,
          draggable: false,
          name: "biela2_" + count.toString(),
        });

        const line = new Konva.Line({
          points: [x1,y1,x2,y2],
          stroke: 'green',
          name: "bielaL_" + count.toString(),
        });

        b1.on('dragstart', (e) => {
          shadowRectangle.show();
          shadowRectangle.moveToTop();
          b1.moveToTop();
          console.log(b1.name())
        });
        b1.on('dragend', (e) => {
          b1.position({
            x: Math.round(b1.x() / blockSnapSize) * blockSnapSize +15,
            y: Math.round(b1.y() / blockSnapSize) * blockSnapSize +15
          });
          stage.batchDraw();
          shadowRectangle.hide();
        });
        b1.on('dragmove', (e) => {
          shadowRectangle.position({
            x: Math.round(b1.x() / blockSnapSize) * blockSnapSize,
            y: Math.round(b1.y() / blockSnapSize) * blockSnapSize
          });
          stage.batchDraw();
        });

        b2.on('dragstart', (e) => {
          shadowRectangle.show();
          shadowRectangle.moveToTop();
          b2.moveToTop();
        });
        b2.on('dragend', (e) => {
          b2.position({
            x: Math.round(b2.x() / blockSnapSize) * blockSnapSize +15,
            y: Math.round(b2.y() / blockSnapSize) * blockSnapSize +15
          });
          stage.batchDraw();
          shadowRectangle.hide();
        });
        b2.on('dragmove', (e) => {
          shadowRectangle.position({
            x: Math.round(b2.x() / blockSnapSize) * blockSnapSize,
            y: Math.round(b2.y() / blockSnapSize) * blockSnapSize
          });
          stage.batchDraw();
        });

        function updateLine() {
          const points = [
            b1.x(),
            b1.y(),
            b2.x(),
            b2.y(),
          ]
          line.points(points);
          layer.batchDraw();
        }

        function updateLineEnd() {
          const points = [
            Math.round(b1.x() / blockSnapSize) * blockSnapSize,
            Math.round(b1.y() / blockSnapSize) * blockSnapSize,
            Math.round(b2.x() / blockSnapSize) * blockSnapSize,
            Math.round(b2.y() / blockSnapSize) * blockSnapSize
          ]
          line.points(points);
          layer.batchDraw();
        }

        b1.on('dragmove', updateLine);
        b2.on('dragmove', updateLine);

        b1.on('dragend', updateLine);
        b2.on('dragend', updateLine);
        
        layer.add(line);
        layer.add(b1);
        layer.add(b2);

        var textInfo1 = new Konva.Text({
          text: "X:" + String(Math.round(b1.x())) + " Y:" + String(Math.round(b1.y())),
          x: b1.x() + 20,
          y: b1.y() + 23,
          fontSize: 13,
          fill: 'black',
          

        });

        b1.on('dragend', (e) => {
          textInfo1.position({
            x: Math.round(b1.x() / blockSnapSize) * blockSnapSize - 45,
            y: Math.round(b1.y() / blockSnapSize) * blockSnapSize + 33

          });
          stage.batchDraw();

          textInfo1.text("X:" + String(Math.round(b1.x())) + " Y:" + String(Math.round(b1.y())) )
          
        });
        
        layer.add(textInfo1);

        var textInfo2 = new Konva.Text({
          text: "X:" + String(Math.round(b2.x())) + " Y:" + String(Math.round(b2.y())),
          x: b2.x() + 20,
          y: b2.y() + 23,
          fontSize: 13,
          fill: 'black',
          
        });

        b2.on('dragend', (e) => {
          textInfo2.position({
            x: Math.round(b2.x() / blockSnapSize) * blockSnapSize - 45,
            y: Math.round(b2.y() / blockSnapSize) * blockSnapSize + 33

          });
          stage.batchDraw();

          textInfo2.text("X:" + String(Math.round(b2.x())) + " Y:" + String(Math.round(b2.y())) )
          
        });
        
        layer.add(textInfo2);
      }

      function newBarra(x, y, width, rotation, layer, stage) {
        var barra = new Konva.Rect({
          x: x,
          y: y,
          width: width,
          height: 30,
          fill: 'gray',
          stroke: 'black',
          strokeWidth: 1,
          shadowColor: 'black',
          shadowBlur: 2,
          shadowOffset: {x : 1, y : 1},
          shadowOpacity: 0.4,
          draggable: false,
          name: "barra",
          rotation: rotation,
        });

        layer.add(barra);
        
        stage.on('click tap', function (e) {
          if (e.target === barra) {

          }
        });   
      }
    
      function newMomento(x, y, rotation, layer, stage, count, magnitud="M") {
        
        let momento = new Konva.Arc({
          x: x,
          y: y,
          innerRadius: 10,
          outerRadius: 20,
          angle: 180,
          fill: 'yellow',
          stroke: 'black',
          strokeWidth: 4,
          shadowColor: 'black',
          shadowBlur: 2,
          shadowOffset: {x : 1, y : 1},
          shadowOpacity: 0.4,
          draggable: false,
          name: "momento_" + count.toString(),
          rotation: rotation,
          magnitud: magnitud
        });
        
        layer.add(momento);
        stage.on('click tap', function (e) {
          if (e.target === momento) {
            textInfo.hide()
            arrow_split = setDclArrows()
            console.log(e.target)
            if (arrow_split == 1){
              newDclMomento(e.target.attrs.x, e.target.attrs.y, 0, layer, stage, count, e.target.attrs.magnitud)
              user_tracking[5] = user_tracking[5] + 1
            } else {
              alert("¡Intenta de nuevo! Este elemento... ¿cuantas fuerzas involucra?")
              strikes += 1
              textInfo.show()
            }
          }
        });

        /// fuerza en momento

        var textNode = new Konva.Text({
          text: "F:" + magnitud,
          x: momento.x() + 20,
          y: momento.y() + 10,
          fontSize: 13,
          name: "textMoment_" + count.toString(),
          fill: 'balck',
        });

        var textInfo= new Konva.Text({
          text: "x:" + String(momento.x()) + " y:" + String(momento.y()) ,
          x: momento.x() + 20,
          y: momento.y() + 23,
          fontSize: 13,
          fill: 'black',
        });

        momento.on('dragend', (e) => {
          textInfo.position({
            x: Math.round(momento.x() / blockSnapSize) * blockSnapSize - 45,
            y: Math.round(momento.y() / blockSnapSize) * blockSnapSize + 33
          });
          stage.batchDraw();
          textInfo.text("X:" + String(momento.x()) + " Y:" + String(momento.y()) )
        });
        layer.add(textNode);
        layer.add(textInfo);
      }
      
      function newDclMomento(x, y, rotation, layer, stage, count, magnitud="M") {
        
        let momento = new Konva.Arc({
          x: x,
          y: y,
          innerRadius: 6,
          outerRadius: 12,
          angle: 180,
          fill: 'red',
          stroke: 'black',
          strokeWidth: 2,
          draggable: false,
          name: "momento_" + count.toString(),
          rotation: rotation,
          magnitud: magnitud
        });
        
        layer.add(momento);

        /// fuerza en momento
        var textNode = new Konva.Text({
          text: "F:" + magnitud,
          x: momento.x() + 20,
          y: momento.y() + 10,
          fontSize: 13,
          name: "textMoment_" + count.toString(),
          fill: 'balck',
        });
        layer.add(textNode);
      }

      function newPunto(x, y, layer, stage) {

        var punto = new Konva.Circle({
          x: x,
          y: y,
          radius: 7.5,
          fill: 'yellow',
          stroke: 'black',
          strokeWidth: 2,
          shadowColor: 'black',
          shadowBlur: 2,
          shadowOffset: {x : 1, y : 1},
          shadowOpacity: 0.4,
          draggable: false,
          name: "punto" 
        });

        layer.add(punto);

        var textInfo= new Konva.Text({
          text: "x:" + String(punto.x()) + " y:" + String(punto.y()) ,
          x: punto.x() - 40,
          y: punto.y() + 10,
          fontSize: 13,
          fill: 'black',
        });
        layer.add(textInfo); 
      }

      
      var dificultad = parseInt($("#homework-details").data("homeworkDifficulty"));
      
        let drawingLine = false;
        let line;
        stage.on('mousedown', (e) => {
          if (e.target.hasName('node')) {
            drawingLine = true;
            const pos = stage.getPointerPosition();
            line = new Konva.Line({
              stroke: 'black',
              strokeWidth: 7,
              // remove line from hit graph, so we can check intersections
              listening: false,
              points: [e.target.x(), e.target.y(), pos.x, pos.y]
            });
            layer.add(line);
          }
        });
        
        stage.on('mouseover', (e) => {
          if (e.target.hasName('node')) {
            e.target.stroke('black');
            layer.draw();
          }
        });
        
        stage.on('mouseout', (e) => {
          if (e.target.hasName('node')) {
            e.target.stroke(null);
            layer.draw();
          }
        });
        
        stage.on('mousemove', (e) => {
          if (!line) {
            return;
          }
          const pos = stage.getPointerPosition();
          const points = line.points().slice();
          points[2] = pos.x;
          points[3] = pos.y;
          line.points(points);
          layer.batchDraw();
        });
        
        stage.on('mouseup', (e) => {
          if (!line) {
            return;
          }
          if (!e.target.hasName('node')) {
            line.destroy();
            layer.draw();
            line = null;
          } else {
            let pos = e.target.getClientRect();
            const points = line.points().slice();
            points[2] = pos.x + (e.target.width()/2);
            points[3] = pos.y + (e.target.height()/2);;
            line.points(points);
            layer.batchDraw();
            line = null;
          }
          
        });

        function setDclArrows() {
          let num_of_arrows = 0;
          let num_of_arrows_answer = prompt("Ingrese el numero de fuerzas involucradas a este elemento \n(1, 2 o 3)");
          if (num_of_arrows_answer == 1) {
            num_of_arrows = 1
          } else if (num_of_arrows_answer == 2){
            num_of_arrows = 2
          } else if (num_of_arrows_answer == 3){
            num_of_arrows = 3
          } 
          return num_of_arrows;
        }

        function checkTracking(element_track, user_track) {
          alert_message = "HINT \n"
          for(var i = 0; i<6; i++){
            if (element_track[i] != user_track[i]){
              if( i == 0){ alert_message = alert_message+"¡Fijate bien! Tienes un problema con una fuerza horizontal o vertical \n"}
              else if( i == 1){ alert_message = alert_message+"Ojo con las fuerzas diagonales, te esta faltando alguna \n"}
              else if( i == 2){ alert_message = alert_message+"Revisa bien las fuerzas relacionadas a los apoyos fijos \n"}
              else if( i == 3){ alert_message = alert_message+"Examina bien las fuerzas de los apoyos deslizantes \n"}
              else if( i == 4){ alert_message = alert_message+"Verifica los empotrados del sistema \n"}
              else if( i == 5){ alert_message = alert_message+"Para el momento tambien debemos señalar su fuerza en el DCL! \n"}
            }
          }
          if (alert_message == "HINT \n"){ 
            alert_message = "Felicidades, tu DCL esta completo"
            //return alert_message
            alert(alert_message) 
            
            let json = stage.toJSON();
            console.log(json)

            let homework_id = $("#homework-details").data("homeworkId")

            function getCookie(name) {
    	        let cookieValue = null;
    	        if (document.cookie && document.cookie !== '') {
        	      const cookies = document.cookie.split(';');
        	      for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                  }
        	      }
    	        }
    	        return cookieValue;
	          }

            $.ajax({
              url: `/homework/${homework_id}/edit_forces`,
              type: "POST",
              data:{
                "diagram2": json,

              },

              beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
              },
              success: function (data) {
                console.log("guardo")
                console.log(json)
              },
              error: function (error) {
                console.log("guardon't")
              }
            });
            let final_stage = $("#homework-details").data("homeworkFinal")
            if (final_stage == 2){ 
              $.ajax({
                url: `/homework/${homework_id}/score`,
                type: "POST",

                beforeSend: function (xhr) {
                  xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                },
                success: function (data) {
                  console.log("success")
                  location.href = '{% url 'student_home' %}'
                },
                error: function (error) {
                  console.log("error")
                }
              });
            } else {
              location.href='balance_equations'
            }
          } else{
            //return alert_message
            alert(alert_message) 
          }
        }

        function clickAllShapes(flechas, fijos, deslizantes, empotrados, momentos){
          for(var i = 0; i<flechas.length; i++){
            if (Math.round(flechas[i]["rotation"]) == 45){
              newDclArrow(flechas[i]["x"] - 20, flechas[i]["y"] + 60, 0, layer, stage, String(flechas[i]["name"]).split("_")[1], String(flechas[i]["magnitud"])+"cos("+String(Math.round(flechas[i]["rotation"]))+")")
              newDclArrow(flechas[i]["x"] + 60, flechas[i]["y"] - 20, 90, layer, stage, String(flechas[i]["name"]).split("_")[1], String(flechas[i]["magnitud"] * -1)+"sen("+String(Math.round(flechas[i]["rotation"]))+")")
            } else if (Math.round(flechas[i]["rotation"]) == 135){
              newDclArrow(flechas[i]["x"] + 20 , flechas[i]["y"] + 60, 180, layer, stage, String(flechas[i]["name"]).split("_")[1], String(flechas[i]["magnitud"])+"cos("+String(Math.round(flechas[i]["rotation"]))+")")
              newDclArrow(flechas[i]["x"] - 60, flechas[i]["y"] - 20, 90, layer, stage, String(flechas[i]["name"]).split("_")[1], String(flechas[i]["magnitud"] * -1)+"sen("+String(Math.round(flechas[i]["rotation"]))+")")
            } else if (Math.round(flechas[i]["rotation"]) == -45){
              newDclArrow(flechas[i]["x"] - 20 , flechas[i]["y"] - 60, 0, layer, stage, String(flechas[i]["name"]).split("_")[1], String(flechas[i]["magnitud"])+"cos("+String(Math.round(flechas[i]["rotation"]))+")")
              newDclArrow(flechas[i]["x"] + 60, flechas[i]["y"] + 20, -90, layer, stage, String(flechas[i]["name"]).split("_")[1],String(flechas[i]["magnitud"] * -1)+"sen("+String(Math.round(flechas[i]["rotation"]))+")")
            } else if (Math.round(flechas[i]["rotation"]) == -135){
              newDclArrow(flechas[i]["x"] + 20 , flechas[i]["y"] - 60, 180, layer, stage, String(flechas[i]["name"]).split("_")[1],String(flechas[i]["magnitud"])+"cos("+String(Math.round(flechas[i]["rotation"]))+")")
              newDclArrow(flechas[i]["x"] - 60, flechas[i]["y"] + 20, -90, layer, stage, String(flechas[i]["name"]).split("_")[1], String(flechas[i]["magnitud"] * -1)+"sen("+String(Math.round(flechas[i]["rotation"]))+")")
            } else if (Math.round(flechas[i]["rotation"]) == 0){
              newDclArrow(flechas[i]["x"], flechas[i]["y"], 0, layer, stage, String(flechas[i]["name"]).split("_")[1], flechas[i]["magnitud"])
            } else if (Math.round(flechas[i]["rotation"]) == -180){
              newDclArrow(flechas[i]["x"], flechas[i]["y"], 180, layer, stage, String(flechas[i]["name"]).split("_")[1], flechas[i]["magnitud"] * -1)
            } else if (Math.round(flechas[i]["rotation"]) == 90){
              newDclArrow(flechas[i]["x"], flechas[i]["y"], 90, layer, stage, String(flechas[i]["name"]).split("_")[1], flechas[i]["magnitud"] * -1)
            } else if (Math.round(flechas[i]["rotation"]) == -90){
              newDclArrow(flechas[i]["x"], flechas[i]["y"], -90, layer, stage, String(flechas[i]["name"]).split("_")[1], flechas[i]["magnitud"])
            } else {
              newDclArrow(flechas[i]["x"], flechas[i]["y"], 0, layer, stage, String(flechas[i]["name"]).split("_")[1], flechas[i]["magnitud"])
            }
          }
          for(var i = 0; i<fijos.length; i++){
            if (Math.round(fijos[i]["rotation"]) == 0){
              newDclArrow(fijos[i]["x"] - 85, fijos[i]["y"], 0, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_x"])
              newDclArrow(fijos[i]["x"], fijos[i]["y"] + 85, -90, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_y"])
            } else if (Math.round(fijos[i]["rotation"]) == 90){
              newDclArrow(fijos[i]["x"] - 85, fijos[i]["y"], 0, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_x"])
              newDclArrow(fijos[i]["x"], fijos[i]["y"] - 85, 90, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_y"])
            } else if (Math.round(fijos[i]["rotation"]) == 180){
              newDclArrow(fijos[i]["x"] + 85, fijos[i]["y"], 180, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_x"])
              newDclArrow(fijos[i]["x"], fijos[i]["y"] - 85, 90, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_y"])
            } else if (Math.round(fijos[i]["rotation"]) == -90){
              newDclArrow(fijos[i]["x"] + 85, fijos[i]["y"], 180, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_x"])
              newDclArrow(fijos[i]["x"], fijos[i]["y"] + 85, -90, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_y"])
            } else {
              newDclArrow(fijos[i]["x"] - 85, fijos[i]["y"], 0, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_x"])
              newDclArrow(fijos[i]["x"], fijos[i]["y"] + 85, -90, layer, stage, String(fijos[i]["name"]).split("_")[1], fijos[i]["magnitud_y"])
            }
          }
          for (var i = 0; i<deslizantes.length; i++){
            if (Math.round(deslizantes[i]["rotation"]) == 0){
              newDclArrow(deslizantes[i]["x"] + 15, deslizantes[i]["y"] + 65, -90, layer, stage, String(deslizantes[i]["name"]).split("_")[1], deslizantes[i]["magnitud"])
            } else if (Math.round(deslizantes[i]["rotation"]) == 90){
              newDclArrow(deslizantes[i]["x"] - 65, deslizantes[i]["y"] + 15, 0, layer, stage, String(deslizantes[i]["name"]).split("_")[1], deslizantes[i]["magnitud"])
            } else if (Math.round(deslizantes[i]["rotation"]) == 180){
              newDclArrow(deslizantes[i]["x"] - 15, deslizantes[i]["y"] - 65, 90, layer, stage, String(deslizantes[i]["name"]).split("_")[1], deslizantes[i]["magnitud"])
            } else if (Math.round(deslizantes[i]["rotation"]) == -90){
              newDclArrow(deslizantes[i]["x"] + 65, deslizantes[i]["y"] - 15, 180, layer, stage, String(deslizantes[i]["name"]).split("_")[1], deslizantes[i]["magnitud"])
            } else {
              newDclArrow(deslizantes[i]["x"] + 15, deslizantes[i]["y"] + 65, -90, layer, stage, String(deslizantes[i]["name"]).split("_")[1], deslizantes[i]["magnitud"])
            }
          }
          for (var i = 0; i<empotrados.length; i++){
            if (Math.round(empotrados[i]["rotation"]) == 0){
              newDclArrow(empotrados[i]["x"] -65, empotrados[i]["y"] - 15, 0, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_x"])
              newDclArrow(empotrados[i]["x"] + 15, empotrados[i]["y"] + 65, -90, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_y"])
              newDclMomento(empotrados[i]["x"] + 30, empotrados[i]["y"] - 30, 0, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_m"])
            } else if (Math.round(empotrados[i]["rotation"]) == 90){
              newDclArrow(empotrados[i]["x"] - 65, empotrados[i]["y"] + 15, 0, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_x"])
              newDclArrow(empotrados[i]["x"] + 15, empotrados[i]["y"] - 65, 90, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_y"])
              newDclMomento(empotrados[i]["x"] + 30, empotrados[i]["y"] + 30, 0, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_m"])
            } else if (Math.round(empotrados[i]["rotation"]) == 180){
              newDclArrow(empotrados[i]["x"] + 65, empotrados[i]["y"] + 15, 180, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_x"])
              newDclArrow(empotrados[i]["x"] -15, empotrados[i]["y"] - 65, 90, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_y"])
              newDclMomento(empotrados[i]["x"] - 30, empotrados[i]["y"] + 30, 0, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_m"])
            } else if (Math.round(empotrados[i]["rotation"]) == -90){
              newDclArrow(empotrados[i]["x"] + 65, empotrados[i]["y"] - 15, 180, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_x"])
              newDclArrow(empotrados[i]["x"] - 15, empotrados[i]["y"] + 65, -90, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_y"])
              newDclMomento(empotrados[i]["x"] - 30, empotrados[i]["y"] -30, 0, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_m"])
            } else {
              newDclArrow(empotrados[i]["x"] -65, empotrados[i]["y"] - 15, 0, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_x"])
              newDclArrow(empotrados[i]["x"] + 15, empotrados[i]["y"] + 65, -90, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_y"])
              newDclMomento(empotrados[i]["x"] + 30, empotrados[i]["y"] - 30, 0, layer, stage, String(empotrados[i]["name"]).split("_")[1], empotrados[i]["magnitud_m"])
            }
          }
          for (var i = 0; i<momentos.length; i++){
            newDclMomento(momentos[i]["x"], momentos[i]["y"], 0, layer, stage, String(momentos[i]["name"]).split("_")[1], momentos[i]["magnitud"])
          }
        }

        shadowRectangle.hide();
        layer.add(shadowRectangle);

        //counter[ARROW, FIJO, DESLIZANTE, EMPOTRADO, ROTULA, BIELA, MOMENTO, PUNTO]
        counter = [0, 0, 0, 0, 0, 0, 0, 0]
        
        fuerzasTotales = loadForm(data, counter);
        

        fuerzas    = cambiarPos(   fuerzasTotales.fuerzas )
        momentos   = cambiarPosMom(fuerzasTotales.momentos )
        incognitas = cambiarPosInc(   fuerzasTotales.incognitas)


        descompuestas = descomponerFuerzas(fuerzas)


        sumas = {}
        
        if(fuerzasTotales.punto){
          sumas = calcularFXYM(incognitas, descompuestas.Fx, descompuestas.Fy, momentos, fuerzasTotales.punto)
        }
        else{
          sumas.strX = 0
          sumas.strY = 0
          sumas.strM = 0
        }

        shape = stage.find('Arc')
        console.log("momentos:")
        console.log(shape)
        
        stage.add(layer);
        layer.draw();
  </script>
    <div class="container" style="margin-top: 20px">
      <div id="selectedDetails" class="row mb-3"></div>
      <div class="row mb-3">
        <div>
          <h4 class="badge text-wrap fs-5" style="background-color: #393E46">Dificultad: {{ homework.difficulty }} </h4> 
        </div>
      </div>
      <div class="row">
        <div class="col-sm">
        </div>
        {% if homework.final_stage == 2 %}
        <div class="col-sm" style="text-align:center">
          <input id="next_btn" type="button" onclick="checkTracking(element_tracking,user_tracking)" value = "Terminar"/>
        </div>
        {% else %}
        <div class="col-sm" style="text-align:center">
          <input id="next_btn" type="button" onclick="checkTracking(element_tracking,user_tracking)" value = "Siguiente etapa"/>
        </div>
        <div class="col-sm" style="text-align:center">
          <input id="next_btn" type="button" onclick="clickAllShapes(answer_arrows, answer_fijo, answer_deslizante, answer_empotrado, answer_momento)" value = "Mostrar Resultado"/>
        </div>
        <div class="col-sm">
          <input id="next_btn" type="button" style="float: right;" onclick="location.href='{% url 'balance_equations' homework_id=homework.id  %}'" value = "Saltar Etapa"/>

        </div>
        {% endif %}
      </div>
    </div>
  </body>
</html>