<!DOCTYPE html>
<html>
	<head>
		<script src="https://unpkg.com/konva@8.3.12/konva.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		
		<meta charset="utf-8" />
		<title>Ecuaciones de equilibrio</title>
		<h2 style="margin_down:20; outline: black solid; text-align:center">Aca saldra un enunciado </h2>
		<style>
			body {
				margin_top: 20;
				margin_left: 20;
				overflow: hidden;
				background-color: #f0f0f0;
				outline: black solid
			}
		</style>
  	</head>
  	<body>
      <h6 id="homework-details" data-homework-id="{{ homework.id }}" data-homework-diagram = "{{ homework.diagram }}"></h6>
    
      <div id="container"></div>
      <script>
        var alto = window.innerHeight - 200;
        var largo = window.innerWidth - 30;
        var shadowOffset = 20;
        var tween = null;
        var blockSnapSize = 30;
  
        var shadowRectangle = new Konva.Rect({
          x: 0,
          y: 0,
          width: blockSnapSize,
          height: blockSnapSize,
          fill: '#FF7B17',
          opacity: 0.6,
          stroke: '#CF6412',
          strokeWidth: 3,
          dash: [20, 2]
        });
        
        data = $("#homework-details").data("homeworkDiagram")
  
        //var stage = Konva.Node.create(data, "container")
  
        function loadForm(json){
          /*
          layer.find('Line').destroy();
          layer.find('Circle').destroy();
          layer.find('Arrow').destroy();
          layer.draw();
          */
          console.log("equis de");
          
          console.log(layer)
          
          console.log(json)
          objects=json["children"][0]["children"]
          console.log(objects["length"])
          
          for (var i = 0; i<objects["length"]; i++){
            console.log(objects[i]["className"]);
            
            //console.log(objects[i]["attrs"]["name"]);
  
            if(objects[i]["className"]=="Rect"){
              if(objects[i]["attrs"]["name"]=='barra'){
                  item=objects[i]
                  
                  newBarra(item["attrs"]["x"], item["attrs"]["y"], layer, stage)
                  
                }
          }
            
            if(objects[i]["className"]=="Arc"){
                if(objects[i]["attrs"]["name"]=='momento'){
                    item=objects[i]
                    console.log("obj: ",item);
                    console.log(item["attrs"]["x"], item["attrs"]["y"])
                    newMomento(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage)
                    
                  }
            }
            if(objects[i]["className"]=="Arrow"){
              if(objects[i]["attrs"]["name"]=='arrow'){
                  item=objects[i]
                  newArrow(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage)
              }
            }
            if(objects[i]["className"]=="RegularPolygon"){
              if(objects[i]["attrs"]["name"]=='fijo'){
                  item=objects[i]
                  newFijo(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage)
              }
            }
            if(objects[i]["className"]=="Group"){
              if(objects[i]["attrs"]["name"]=='deslizante'){
                  item=objects[i]
                  newDeslizante(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage)
              }
              else if(objects[i]["attrs"]["name"]=='empotrado'){
                item=objects[i]
                newEmpotrado(item["attrs"]["x"], item["attrs"]["y"], item["attrs"]["rotation"], layer, stage) 
              }
            }
            if(objects[i]["className"]=="Circle" || objects[i]["className"]=="Line"){
              if(objects[i]["attrs"]["name"]=='rotula'){
                item=objects[i]
                newRotula(item["attrs"]["x"], item["attrs"]["y"], layer, stage) 
              }
              else if(objects[i]["attrs"]["name"]=='biela1'){
                item=objects[i]
                x1 = item["attrs"]["x"]
                y1 = item["attrs"]["y"]
  
                if(typeof(x1) != "undefined" && typeof(x2) != "undefined" && typeof(y1) != "undefined" && typeof(y2)){
                  newBiela( x1, y1, x2, y2, layer, stage)
                }
              }
              else if(objects[i]["attrs"]["name"]=='biela2'){
                item=objects[i]
                x2 = item["attrs"]["x"]
                y2 = item["attrs"]["y"]
                if(typeof(x1) != "undefined" && typeof(x2) != "undefined" && typeof(y1) != "undefined" && typeof(y2)){
                  newBiela( x1, y1, x2, y2, layer, stage)
                }
              }
            }
          }   
        }
  
        console.log("data entrandte:");
        console.log(data["children"][0]["children"]);
        console.log("fin");
  
        const stage = new Konva.Stage({
            container: 'container',
            width: largo,
            height: alto
          });
      
        
        var layer = new Konva.Layer();
          
        var padding = 30;
        for (var i = 0; i < (largo / padding) - 2; i++) {
          layer.add(new Konva.Line({
            points: [Math.round(i * padding) + 0.5, 0, Math.round(i * padding) + 0.5, alto],
            stroke: '#000000',
            strokeWidth: 1,
          }));
        }
        layer.add(new Konva.Line({points: [0,0,10,10]}));
        
        for (var j = 0; j < (largo / padding); j++) {
          layer.add(new Konva.Line({
            points: [0, Math.round(j * padding), largo - 85, Math.round(j * padding)],
            stroke: '#000000',
            strokeWidth: 0.5,
          }));
        }
  
        function newArrow(x, y, rotation, layer, stage) {
          var arrow = new Konva.Arrow({
            x: x,
            y: y,
            points: [0, 0, 75, 0],
            pointerLength: 2,
            pointerWidth: 2,
            fill: 'black',
            stroke: 'black',
            strokeWidth: 4,
            shadowColor: 'black',
            shadowBlur: 2,
            shadowOffset: {x : 1, y : 1},
            shadowOpacity: 0.4,
            draggable: true,
            rotation: 0,
            name: "arrow",
            rotation: rotation,
          });
  
          var tr = new Konva.Transformer({
            nodes: [arrow],
            centeredScaling: false,
            resizeEnabled: false,
            rotation: 0,
            rotationSnaps: [0, 45, 90, 135, 180, 225, 270, 315, 360],
            rotationSnapTolerance: 22.5,
          });
          layer.add(tr);
          
          layer.add(arrow);
          stage.on('click tap', function (e) {
            // if click on empty area - remove all selections
            if (e.target === stage) {
              tr.nodes([]);
              return;
            }
          });
        }
  
        function newFijo(x, y, rotation, layer, stage) {
          let fijo = new Konva.RegularPolygon({
            x: x,
            y: y,
            sides: 3,
            radius: 15,
            fill: 'grey',
            stroke: 'black',
            strokeWidth: 2,
            shadowColor: 'black',
            shadowBlur: 2,
            shadowOffset: {x : 1, y : 1},
            shadowOpacity: 0.4,
            draggable: true,
            name: "fijo",
            rotation: rotation,
          });

          layer.add(fijo);
        }
        
        function toolBar(layer, stage) {
          // PRETTY
          var separadorTool = new Konva.Line({
            points: [largo - 85, 0, largo - 85, 600],
            stroke: 'red',
            strokeWidth: 4,
            lineCap: 'round',
            lineJoin: 'round',
            
          });
          layer.add(separadorTool)
          
          // ARROW
          let arrow = new Konva.Arrow({
            x: largo - 37.5,
            y: 35,
            points: [0, 0, 20, 10],
            pointerLength: 2,
            pointerWidth: 2,
            rotation: 62,
            fill: 'black',
            stroke: 'black',
            strokeWidth: 4,
            shadowColor: 'black',
            shadowBlur: 2,
            shadowOffset: {x : 1, y : 1},
            shadowOpacity: 0.4,
            draggable: false,
          });
  
          var arrowText = new Konva.Text({
            x: largo - 52,
            y: 65,
            text: 'Fuerza',
            fontSize: 12,
            fontFamily: 'Calibri',
            fill: 'balck',
          });
          layer.add(arrowText);
          // ARROW
          // FIJO
          var fijo = new Konva.RegularPolygon({
            x: largo - 35,
            y: 110,
            sides: 3,
            radius: 15,
            fill: 'gray',
            stroke: 'black',
            strokeWidth: 2,
          });
  
          var fijoText = new Konva.Text({
            x: largo - 43,
            y: 125,
            text: 'Fijo',
            fontSize: 12,
            fontFamily: 'Calibri',
            fill: 'balck',
          });
          layer.add(fijoText);
          // FIJO
          // DESLIZANTE
          var deslizante = new Konva.Group({
            x: largo - 50,
            y: 180,
          });
  
          var deslizanteT = new Konva.RegularPolygon({
            x: 15,
            y: -10,
            sides: 3,
            radius: 15,
            fill: 'gray',
            stroke: 'black',
            strokeWidth: 2,
          });
  
          var deslizanteL = new Konva.Line({
            points: [0, 0, 30, 0],
            stroke: 'red',
            strokeWidth: 4,
            lineCap: 'round',
            lineJoin: 'round',
            
          });
  
          deslizante.add(deslizanteT);
          deslizante.add(deslizanteL);
  
          var deslizanteText = new Konva.Text({
            x: largo - 60,
            y: 185,
            text: 'Deslizante',
            fontSize: 12,
            fontFamily: 'Calibri',
            fill: 'balck',
          });
          layer.add(deslizanteText);
          // DESLIZANTE
          // EMPOTRADO
          var empotrado = new Konva.Group({
            x: largo - 50,
            y: 240,
          });
  
          var empotrado1 = new Konva.Line({
            points: [15, 0, 15, -25],
            stroke: 'red',
            strokeWidth: 4,
            lineCap: 'round',
            lineJoin: 'round',
            
          });
  
          var empotrado2 = new Konva.Line({
            points: [0, 0, 30, 0],
            stroke: 'red',
            strokeWidth: 4,
            lineCap: 'round',
            lineJoin: 'round',
            
          });
  
          empotrado.add(empotrado1);
          empotrado.add(empotrado2);
  
          var empotradoText = new Konva.Text({
            x: largo - 80,
            y: 245,
            text: 'Empotramiento',
            fontSize: 12,
            fontFamily: 'Calibri',
            fill: 'balck',
          });
          layer.add(empotradoText);
          // EMPOTRADO
          // ROTULA
          var rotula = new Konva.Circle({
            x: largo - 35,
            y: 285,
            radius: 7.5,
            fill: 'red',
            stroke: 'black',
            strokeWidth: 2,
          });

          var rotulaText = new Konva.Text({
            x: largo - 50,
            y: 305,
            text: 'Rotula',
            fontSize: 12,
            fontFamily: 'Calibri',
            fill: 'balck',
          });
          layer.add(rotulaText);
          // ROTULA
          // BIELA
          var biela = new Konva.Circle({
            x: largo - 35,
            y: 345,
            radius: 7.5,
            fill: 'green',
            stroke: 'black',
            strokeWidth: 2,
          });
          var bielaText = new Konva.Text({
            x: largo - 50,
            y: 365,
            text: 'Biela',
            fontSize: 12,
            fontFamily: 'Calibri',
            fill: 'balck',
          });
          layer.add(bielaText);
          // BIELA
  
          //MOMENTO
          let momento = new Konva.Arc({
            x: largo - 37.5,
            y: 400,
            innerRadius: 10,
            outerRadius: 20,
            angle: 180,
            fill: 'yellow',
            stroke: 'black',
            strokeWidth: 4,
            shadowColor: 'black',
            shadowBlur: 2,
            shadowOffset: {x : 1, y : 1},
            shadowOpacity: 0.4,
            draggable: false,
          });
  
          var momentoText = new Konva.Text({
            x: largo - 57,
            y: 425,
            text: 'momento',
            fontSize: 12,
            fontFamily: 'Calibri',
            fill: 'balck',
          });
          layer.add(momentoText);
          //MOMENTO
  
          //BARRA
          let barra = new Konva.Rect({
            x: largo -50,
            y: 450,
            width: 25,
            height: 25,
            
            fill: 'gray',
            stroke: 'black',
            strokeWidth: 3,
            shadowColor: 'black',
            shadowBlur: 2,
            shadowOffset: {x : 1, y : 1},
            shadowOpacity: 0.4,
            draggable: false,
          });
  
          var barraText = new Konva.Text({
            x: largo - 50,
            y: 480,
            text: 'barra',
            fontSize: 12,
            fontFamily: 'Calibri',
            fill: 'balck',
          });
          layer.add(barraText);
          //BARRA
  
          layer.add(arrow);
          layer.add(fijo);
          layer.add(deslizante);
          layer.add(empotrado);
          layer.add(rotula);
          layer.add(biela);
          layer.add(momento);
          layer.add(barra);
  
        }
        
        
        
        let drawingLine = false;
        let line;
        stage.on('mousedown', (e) => {
          if (e.target.hasName('node')) {
            drawingLine = true;
            const pos = stage.getPointerPosition();
            line = new Konva.Line({
              stroke: 'black',
              strokeWidth: 7,
              // remove line from hit graph, so we can check intersections
              listening: false,
              points: [e.target.x(), e.target.y(), pos.x, pos.y]
            });
            layer.add(line);
          }
        });
          
        stage.on('mouseover', (e) => {
          if (e.target.hasName('node')) {
            e.target.stroke('black');
            layer.draw();
          }
        });
          
        stage.on('mouseout', (e) => {
          if (e.target.hasName('node')) {
            e.target.stroke(null);
            layer.draw();
          }
        });
          
        stage.on('mousemove', (e) => {
          if (!line) {
            return;
          }
          const pos = stage.getPointerPosition();
          const points = line.points().slice();
          points[2] = pos.x;
          points[3] = pos.y;
          line.points(points);
          layer.batchDraw();
        });
          
        stage.on('mouseup', (e) => {
          if (!line) {
            return;
          }
          if (!e.target.hasName('node')) {
            line.destroy();
            layer.draw();
            line = null;
          } else {
            let pos = e.target.getClientRect();
            const points = line.points().slice();
            points[2] = pos.x + (e.target.width()/2);
            points[3] = pos.y + (e.target.height()/2);;
            line.points(points);
            layer.batchDraw();
            line = null;
          }      
        });
  
        shadowRectangle.hide();
        layer.add(shadowRectangle);

        toolBar(layer, stage);
        loadForm(data);
        
        stage.add(layer);
        layer.draw();
    </script>
    <div>
      <input id="btn_save" type="button" style="float: left;" value = "Guardar"/>
      <input id="next_btn" type="button" style="float: right;" onclick="location.href='{% url 'home_admin' %}'" value = "Home"/>
    </div>
  </body>
</html>